<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Extra-Curricular Activities</title>

  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script>

  <style>

*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{margin:0;background:#f6f7fb;color:#111}
.container{max-width:900px;margin:24px auto;padding:16px;background:#fff;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}


header h1{margin:0 0 12px 0;font-size:22px}


.controls{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.controls input{flex:1;padding:8px;border:1px solid #ccc;border-radius:4px}


.sort{display:flex;gap:8px;align-items:center;background:#f4f6fb;border:1px solid #e0e5f2;padding:8px 10px;border-radius:10px}
.sort select{padding:6px 8px;border:1px solid #cbd2e0;border-radius:8px;background:#fff}
.order-toggle{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:0;border-radius:8px;background:#1e88e5;color:#fff;cursor:pointer}
.order-toggle:hover{background:#1669c1}


.lessons{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.lesson{display:flex;flex-direction:column;gap:10px;padding:12px;border:1px solid #e6e8f0;border-radius:10px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.05);min-height:170px}


.lesson-left{display:flex;gap:10px}
.lesson-left > div{min-width:0}
.lesson-icon{width:36px;height:36px;object-fit:contain}


.lesson-left .title{font-weight:600;margin:0 0 4px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lesson-left .meta{font-size:13px;color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}


.lesson-right button{padding:8px 10px;border-radius:8px;border:0;background:#1e88e5;color:#fff;cursor:pointer}
.lesson-right button:hover{background:#1669c1}
.lesson-right button[disabled]{background:#c3c7d1}


.cart-panel{padding:12px;background:#fbfbff;border:1px solid #eef;margin-top:12px;border-radius:6px}
.cart-panel ul{list-style:none;margin:8px 0 0;padding:0;display:grid;gap:8px}


.cart-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid #e6e8f0;border-radius:8px;background:#fff}
.cart-item .info{display:flex;gap:10px}
.cart-item button.remove{background:#e53935;color:#fff;border:0;border-radius:6px;padding:6px 10px;cursor:pointer}
.cart-item button.remove:hover{background:#c62828}


.checkout-form{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.checkout-form .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.checkout-form label{font-size:13px;color:#444;margin-bottom:6px}
.checkout-form input{padding:10px 12px;border:1px solid #cbd2e0;border-radius:8px}
.checkout-form input:focus{outline:none;border-color:#1e88e5;box-shadow:0 0 0 3px rgba(30,136,229,0.15)}
.checkout-form button{padding:10px 12px;border-radius:8px;border:0;background:#1e88e5;color:#fff;cursor:pointer}
.checkout-form button:hover{background:#1669c1}
.checkout-form button[disabled]{background:#c3c7d1}
.checkout-form .back-btn{background:#fff;color:#1e88e5;border:1px solid #cbd2e0}

.field-error{color:#b00020;font-size:13px}
.info{padding:8px;background:#e8f4ff;border-radius:4px;margin:8px 0}
footer{text-align:center;color:#666;font-size:13px;margin-top:12px}
  </style>
</head>

<body>
  <div id="app" class="container">

    <header>
      <h1>Extra-Curricular Activities</h1>
    </header>

    <!-- search, sort, cart button -->
    <section class="controls">
      <input v-model.trim="searchText" @input="onSearchInput" placeholder="Search lessons">

      <div class="sort">
        <label for="sortBy">Sort</label>
        <select id="sortBy" v-model="sortBy">
          <option value="topic">subject</option>
          <option value="location">location</option>
          <option value="price">price</option>
          <option value="space">spaces</option>
        </select>

        <button class="order-toggle" @click="toggleOrder">
          <span class="arrow">{{ sortDir === 'asc' ? '↑' : '↓' }}</span>
          <span class="text">{{ sortDir }}</span>
        </button>
      </div>

      <button @click="toggleCart" :disabled="cart.length === 0" class="cart-btn">
        Cart ({{ cart.length }})
      </button>
    </section>

    <!-- load states -->
    <div v-if="loading">loading...</div>
    <div v-if="loadError">{{ loadError }}</div>

    <!-- lessons list -->
    <main v-if="!showCart">
      <ul class="lessons">
        <li v-for="lesson in pagedAndSortedLessons" :key="lesson._id" class="lesson">
          <div class="lesson-left">
            <img :src="iconFor(lesson)" class="lesson-icon">
            <div>
              <div class="title">Subject: {{ lesson.topic }}</div>
              <div class="meta">Location: {{ lesson.location }}</div>
              <div class="meta">Price: AED {{ lesson.price }}</div>
              <div class="meta">Spaces: {{ lesson.space }}</div>
            </div>
          </div>

          <div class="lesson-right">
            <button @click="addToCart(lesson)" :disabled="lesson.space <= 0">
              Add to cart
            </button>
          </div>
        </li>
      </ul>
    </main>

    <!-- cart panel -->
    <aside v-if="showCart" class="cart-panel">
      <h2>Shopping cart</h2>

      <ul>
        <li v-for="(item, index) in cart" :key="item.instanceId" class="cart-item">
          <div class="info">
            <img :src="iconFor(item)">
            <div>
              <div class="title">{{ item.topic }}</div>
              <div class="meta">{{ item.location }} · AED {{ item.price }}</div>
            </div>
          </div>

          <button class="remove" @click="removeFromCart(index)">remove</button>
        </li>
      </ul>

      <!-- checkout -->
      <form @submit.prevent="submitOrder" class="checkout-form">
        <div class="form-grid">
          <div>
            <label>Name</label>
            <input v-model.trim="customer.name">
            <div v-if="nameError" class="field-error">{{ nameError }}</div>
          </div>

          <div>
            <label>Phone</label>
            <input v-model.trim="customer.phone">
            <div v-if="phoneError" class="field-error">{{ phoneError }}</div>
          </div>
        </div>

        <button type="submit" :disabled="!canCheckout">checkout</button>
        <button type="button" class="back-btn" @click="toggleCart">back to lessons</button>
      </form>

      <div v-if="orderMessage" class="info">{{ orderMessage }}</div>
    </aside>

  </div>

<script>
new Vue({
  el: '#app',

  data: {
    searchText: '',
    sortBy: 'topic',
    sortDir: 'asc',
    showCart: false,
    orderMessage: '',
    loading: true,
    loadError: '',
    customer: { name: '', phone: '' },
    lessons: [],
    cart: []
  },

  created() {
    this.fetchLessons(); // load lessons
  },

  computed: {
    // sorted lessons
    pagedAndSortedLessons() {
      const arr = this.lessons.slice();
      const key = this.sortBy;
      const dir = this.sortDir === 'asc' ? 1 : -1;

      arr.sort((a, b) => {
        let av = a[key];
        let bv = b[key];

        if (av === undefined) av = '';
        if (bv === undefined) bv = '';

        const aNum = typeof av === 'number';
        const bNum = typeof bv === 'number';

        if (aNum && bNum) {
          return av < bv ? -1 * dir : av > bv ? 1 * dir : 0;
        }

        av = av.toString().toLowerCase();
        bv = bv.toString().toLowerCase();
        return av < bv ? -1 * dir : av > bv ? 1 * dir : 0;
      });

      return arr;
    },

    // name error
    nameError() {
      if (!this.customer.name) return '';
      return /^[A-Za-z ]+$/.test(this.customer.name) ? '' : 'letters only';
    },

    // phone error
    phoneError() {
      if (!this.customer.phone) return '';
      return /^[0-9]+$/.test(this.customer.phone) ? '' : 'numbers only';
    },

    // checkout allowed
    canCheckout() {
      return this.customer.name &&
             this.customer.phone &&
             !this.nameError &&
             !this.phoneError &&
             this.cart.length > 0;
    }
  },

  methods: {
    // load lessons or search
    fetchLessons(query = '') {
      this.loading = true;
      const url = query
        ? `https://extracurricular-activities.onrender.com/search?q=${encodeURIComponent(query)}`
        : `https://extracurricular-activities.onrender.com/lessons`;

      fetch(url)
        .then(r => r.json())
        .then(data => {
          this.lessons = Array.isArray(data) ? data : [];
        })
        .catch(() => {
          this.loadError = 'server unreachable';
        })
        .finally(() => {
          this.loading = false;
        });
    },

    // input search
    onSearchInput() {
      this.fetchLessons(this.searchText || '');
    },

    // switch sort direction
    toggleOrder() {
      this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
    },

    // icon path
    iconFor(lesson) {
      return `https://extracurricular-activities.onrender.com/images/${lesson.icon}`;
    },

    // add to cart
    addToCart(lesson) {
      if (!lesson || lesson.space <= 0) return;

      const instanceId =
        Date.now().toString(36) + Math.random().toString(36).slice(2, 8);

      this.cart.push({
        instanceId,
        _id: lesson._id,
        topic: lesson.topic,
        location: lesson.location,
        price: lesson.price
      });

      lesson.space = Math.max(0, lesson.space - 1);
      this.orderMessage = '';
    },

    // remove item
    removeFromCart(index) {
      const item = this.cart[index];
      const lesson = this.lessons.find(l => l._id === item._id);
      if (lesson) lesson.space += 1;
      this.cart.splice(index, 1);
      this.orderMessage = '';
    },

    // show/hide cart
    toggleCart() {
      this.showCart = !this.showCart;
    },

    // submit order
    submitOrder() {
      if (!this.canCheckout) return;

      const order = {
        name: this.customer.name,
        phone: this.customer.phone,
        lessons: this.cart.map(i => i._id)
      };

      fetch('https://extracurricular-activities.onrender.com/order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(order)
      }).then(() => {
        // update spaces in db
        this.cart.forEach(item => {
          const lesson = this.lessons.find(l => l._id === item._id);
          if (lesson) {
            fetch(`https://extracurricular-activities.onrender.com/lesson/${lesson._id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ space: lesson.space })
            });
          }
        });

        // reset
        this.orderMessage = 'order submitted successfully';
        this.cart = [];
        this.customer.name = '';
        this.customer.phone = '';
      });
    }
  }
});
</script>
</body>
</html>